<template>
  
  <div class="page">
    <!--##### MOBILE -->
    <div v-if="smAndDown" class="page-content d-flex flex-column align-center">
      
      <p class="page-content__title-m opacity--4 top--un12" >VEM AÍ</p>
      <p class="page-content__title-m opacity--3" >VEM AÍ</p>
      <p class="page-content__title-m" >VEM AÍ</p>
      

      <p class="page-content__subtitle-m">Um dos maiores e mais prestigiados</p>
      <p class="page-content__subtitle-m top--un4">eventos do YSP do ano de 2021.</p>

      <p class="page-content__text">Um evento que contará com vários jovens de</p>
      <p class="page-content__text top--un4">destaque, das mais diversas áreas, discutindo </p>
      <p class="page-content__text top--un4">sobre o que mais importa para você!</p>

      <p class="page-content__moto-m">Qual o seu legado?</p>

      <p class="page-content__date-m">Descubra no dia 14 de agosto</p>

      <div>
        <button v-if="showButton" class="button__subscribe-m" @click="subscribe()" >Inscreva-se</button>
        <form v-if="!showButton && !isSubscribed" class="form-m d-flex flex-column">
          <div class="d-flex align-center justify-space-between">
            <label class="label-m" for="name">Nome</label>
            <input id="name" v-model="form.name" style="width: 100%;" class="input-m" type="text" name="name" placeholder="Digite seu nome completo">
          </div>
          <div class="d-flex align-center justify-space-between">
            <label class="label-m" for="email">Email</label>
            <input id="email" v-model="form.email" style="width: 100%;" class="input-m" type="text" name="email" placeholder="Digite seu melhor email">
          </div>
          <div class="d-flex align-center justify-space-between">
            <select id="state" v-model="form.state" class="select-state select-state-m" name="state" form="stateform">
              <option value="" disabled="disabled" selected="selected">Estado</option>
              <option v-for="(state, i) in allStates" :key="i" :value="state.value">{{state.short}}</option>
            </select>

            <select id="city" v-model="form.city" :disabled="allCities.length == 0" style="width: 100%;" class="select-state select-state-m" name="city" form="stateform">
              <option value="" disabled="disabled" selected="selected">Cidade</option>
              <option v-for="(city, i) in allCities" :key="i" :value="city.value">{{city.value}}</option>
            </select>
          </div>
        </form>
        <p v-if="isSubscribed" class="page-content__subscribed-m">Inscrição realizada com sucesso!</p>
      </div>
      
      <img v-if="showButton" class="img-ysp-m" src="~/static/img/ysp_logo.png" >
      <div v-else style='cursor: pointer;' @click="handleSubmit('mobile')">
        <img class="img-ysp-m" src="~/static/img/ysp_logo.png" >
        <p class="page-content__date-m mt-0">Enviar</p>
      </div>
    </div>

    <!--##### WEB -->
    <div v-else class="page-content d-flex flex-column align-center">
      
      <p class="page-content__title-w opacity--2 top--un110" >VEM AÍ</p>
      <p class="page-content__title-w" >VEM AÍ</p>
      

      <p class="page-content__subtitle-w">Um dos maiores e mais prestigiados</p>
      <p class="page-content__subtitle-w top--un14">eventos do YSP do ano de 2021.</p>

      <p class="page-content__moto-w">Qual o seu legado?</p>

      <p class="page-content__date-w">Descubra no dia 14 de agosto</p>

      <div>
        <button v-if="showButton" class="button__subscribe-w" @click="subscribe()" >Inscreva-se</button>
        <form v-if="!showButton && !isSubscribed" class="form-w d-flex flex-column">
          <div class="d-flex align-center justify-space-between">
            <label class="label-w" for="name">Nome</label>
            <input id="name" v-model="form.name" style="width: 100%;" class="input-w" type="text" name="name" placeholder="Digite seu nome completo">
          </div>
          <div class="d-flex align-center justify-space-between">
            <label class="label-w" for="email">Email</label>
            <input id="email" v-model="form.email" style="width: 100%;" class="input-w" type="text" name="email" placeholder="Digite seu melhor email">
          </div>
          <div class="d-flex align-center justify-space-between">
            <select id="state" v-model="form.state" class="select-state select-state-w" name="state" form="stateform">
              <option value="" disabled="disabled" selected="selected">Estado</option>
              <option v-for="(state, i) in allStates" :key="i" :value="state.value">{{state.short}}</option>
            </select>

            <select id="city" v-model="form.city" :disabled="allCities.length == 0" style="width: 100%;" class="select-state select-state-w" name="city" form="stateform">
              <option value="" disabled="disabled" selected="selected">Cidade</option>
              <option v-for="(city, i) in allCities" :key="i" :value="city.value">{{city.value}}</option>
            </select>
          </div>
        </form>
        <p v-if="isSubscribed" class="page-content__subscribed-w">Inscrição realizada com sucesso!</p>
      </div>
      
      <img v-if="showButton" class="img-ysp-w" src="~/static/img/ysp_logo.png">
      <v-tooltip v-else bottom >
        <template #activator="{ on, attrs }">
          <img  v-bind="attrs" class="img-ysp-w" style='cursor: pointer;' src="~/static/img/ysp_logo.png" v-on="on" @click="handleSubmit('web')" >
        </template>
        <span>ENVIAR</span>
      </v-tooltip> 
    </div>
    <div class="page-background">
      <img class="page-background__background" src="~/static/img/fullscreen-background.png" >
    </div>
  </div>
</template>

<script>

export default({
  name: 'YspLeadsIndex',
  async asyncData({ $axios }) {
    const allStatesOfBrazil = await $axios.$get(
      `${process.env.brasilApi}ibge/uf/v1`
    )
    return { allStatesOfBrazil }
  },
  data () {
    return {
      showButton: true,
      isSubscribed: false,
      form: {
        name: '',
        email: '',
        state: '',
        city: '',
      },
      allStates: [],
      allCities: [],
    }
  },
  computed: {
    smAndUp() {
      return this.$vuetify.breakpoint.smAndUp
    },
    mdAndUp() {
      return this.$vuetify.breakpoint.mdAndUp
    },
    smAndDown() {
      return this.$vuetify.breakpoint.smAndDown
    },
    xsOnly() {
      return this.$vuetify.breakpoint.xsOnly
    }
  },
  watch: {
    'form.state'(paylod) {
      if (paylod) {
        const chosenState = this.allStates.find(
          (state) => state.value === paylod
        )
        this.form.city = ""
        this.getAndSetCitiesByStateCodeAsync(chosenState.id)
      }
    },
  },
  mounted() {
    this.allStates = this.formatDataFromIbge(this.allStatesOfBrazil)
    // this.sendAnalyticsData()
  },
  methods: {
    subscribe() {
      this.sendAnalyticsData('button_subscribe')
      this.showButton = false
    },
    formatDataFromIbge(states) {
      return states.reduce((acc, state) => {
        return [
          ...acc,
          {
            value: state.nome,
            short: state.sigla,
            id: state.id,
          },
        ]
      }, [])
    },
    async getAndSetCitiesByStateCodeAsync(stateId) {
      const { data } = await this.$axios.get(
        `${process.env.ibgeApi}localidades/estados/${stateId}/municipios`
      )
      this.allCities = this.formatDataFromIbge(data)
    },
    validate() {
      if(!this.form.name) {
        this.$toast.open({message: "Por favor preencha seu nome completo", type: "warning"})
        return false
      }
      if(!this.form.email) {
        this.$toast.open({message: "Por favor preencha seu email", type: "warning"})
        return false
      }
      const regexEmail = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      if (!this.form.email.match(regexEmail)) {
        this.$toast.open({message: "Por favor insira um email válido", type: "warning"})
        return false
      }
      if(!this.form.state) {
        this.$toast.open({message: "Por favor selecione seu estado", type: "warning"})
        return false
      }
      if(!this.form.city) {
        this.$toast.open({message: "Por favor selecione sua cidade", type: "warning"})
        return false
      }
      return true
    },
    getDataToSubmit() {
      return {
        name: this.form.name, 
        email: this.form.email.toLowerCase(), 
        state: this.form.state, 
        city: this.form.city, 
      }
    },
    handleSubmit(deviceType) {
      if(!this.isSubscribed && this.validate()) {
        try {
          this.$axios.setHeader('apikey', process.env.SUPABASE_API_KEY)
          this.$axios.post('leads', {...this.getDataToSubmit(), device: deviceType})
          this.isSubscribed = true
        } catch (err) {
          this.$toast.open({message: "Falha ao enviar dados, por favor tente novamente.", type: "error"})
        }
      }
    },
    sendAnalyticsData(typeData = 'page_read') {
      try {
        const deviceType = this.smAndDown ? 'mobile' : 'web'
        this.$axios.setHeader('apikey', process.env.SUPABASE_API_KEY)
        this.$axios.post('analytics', {type: typeData, device: deviceType})
      } catch (err) {
        console.error(err)
      }
    }
  }
})
</script>


<style lang="scss" scoped>
.page {
  .page-content {
    position: relative;
    z-index: 2;

    &__title {
      &-w {
        font-size: 130px;
        font-weight: 800;
        color: #f2de79;
        margin: -12px 0 -56px 0;
      }
      &-m {
        font-size: 86px;
        font-weight: 800;
        color: #f2de79;
        margin: -8px 0 -38px 0;
      }
    }

    &__subtitle {
      &-w {
        font-size: 34px;
        font-weight: 400;
        color: #f2de79;
        text-align: center;
        margin: 48px 0 0 0;
      }
      &-m {
        font-size: 18px;
        font-weight: 500;
        color: #f2de79;
        text-align: center;
        margin: 48px 0 0 0;
      }
    }

    &__text {
      font-size: 16px;
      font-weight: 400;
      color: #f2de79;
      text-align: center;
      margin: 28px 0 0 0;
    }

    &__moto {
      &-w {
        font-size: 36px;
        font-weight: 800;
        color: #f2de79;
        text-align: center;
        text-transform: uppercase;
        margin: 21px 0 0 0;
      }
      &-m {
        font-size: 24px;
        font-weight: 800;
        color: #f2de79;
        text-align: center;
        text-transform: uppercase;
        margin: 32px 0 0 0;
      }
    }

    &__date {
      &-w {
        font-size: 20px;
        font-weight: 500;
        color: #f2de79;
        text-align: center;
        margin: 2px 0 0 0;
      }
      &-m {
        font-size: 14px;
        font-weight: 500;
        color: #f2de79;
        text-align: center;
        margin: 6px 0 0 0;
      }
    }

    &__subscribed {
      &-w {
        font-size: 36px;
        font-weight: 400;
        color: #f2de79;
        text-align: center;
        margin: 46px 0;
      }
      &-m {
        font-size: 24px;
        font-weight: 500;
        color: #f2de79;
        text-align: center;
        margin: 56px 0;
      }
    }

    .button {
      &__subscribe {
        &-w {
          transition-duration: 0.4s;
          color: #f2de79;
          font-size: 46px;
          font-weight: 500;
          text-transform: uppercase;
          padding: 4px 48px;
          border: 2px solid #f2de79;
          border-radius: 60px;
          margin: 24px 0;
        }
        &-m {
          transition-duration: 0.4s;
          color: #f2de79;
          font-size: 28px;
          font-weight: 500;
          text-transform: uppercase;
          padding: 6px 32px;
          border: 2px solid #f2de79;
          border-radius: 60px;
          margin: 42px 0;
        }
      }
    }

    .opacity {
      &--1 {
        opacity: 0.7;
      }
      &--2 {
        opacity: 0.5;
      }
      &--3 {
        opacity: 0.35;
      }
      &--4 {
        opacity: 0.18;
      }
    }

    .top {
      &--un4 {
        margin-top: -4px;
      }
      &--un14 {
        margin-top: -14px;
      }
      &--un12 {
        margin-top: -12px;
      }
      &--un70 {
        margin-top: -70px;
      }
      &--un110 {
        margin-top: -110px;
      }
    }

    .img-ysp {
      &-w {
        height: 70px;
      }
      &-m {
        height: 40px;
      }
    }

    .label {
      &-w {
        font-size: 20px;
        font-weight: 500;
        color: #f2de79;
        margin-right: 32px;
      }
      &-m {
        font-size: 12px;
        font-weight: 500;
        color: #f2de79;
        margin-right: 26px;
      }
    }

    .input {
      &-w[type=text] {
        padding: 12px 20px;
        margin: 6px 0;
        display: inline-block;
        border: 2px solid #f2de79;
        border-radius: 24px;
        box-sizing: border-box;
        color: #f2de79;
      }
      &-m[type=text] {
        padding: 8px 6px;
        margin: 6px 0;
        padding-left: 12px;
        display: inline-block;
        border: 2px solid #f2de79;
        border-radius: 24px;
        box-sizing: border-box;
        color: #f2de79;
      }
    }

    .form {
      &-w {
        margin: 10px 0;
        min-width: 34vw;
      }
      &-m {
        margin: 18px 0;
      }
    }

    input:focus {
      outline: none;
      border: 2px solid #fada39;
    }

    .select-state {
        -webkit-appearance: none;
        color: #f2de79;
        margin: 0 4px;
        border: 2px solid #f2de79;
        border-radius: 24px;
        text-align: center;
        cursor: pointer;
        overflow:hidden;
        white-space:nowrap; 
        text-overflow:ellipsis;

        option {
          color: #223254;
          text-overflow:ellipsis;
          overflow:hidden;
        }

        option[value=""][disabled] {
          display: none
        }
          
        &:focus {
          outline: none;
          border: 2px solid #fada39;
        }

        &:hover {
          outline: none;
          border: 2px solid #fada39;
        }

        &[disabled] {
          outline: none;
          border: 2px solid #fada3998;
          cursor: not-allowed;
        }
    }

    .select-state-w {
      padding: 8px 20px;
      font-size: 20px;

      option {
        font-size: 14px;
      }
    }

    .select-state-m {
      padding: 10px 6px;
      font-size: 14px;

      option {
        font-size: 14px;
      }
    }
  }
  .page-background {
    position: fixed; 
    top: -50%; 
    left: -50%; 
    width: 200%; 
    height: 200%;

    &__background {
      position: absolute; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      margin: auto; 
      min-width: 50%;
      min-height: 50%;
    }
  }
}
</style>
